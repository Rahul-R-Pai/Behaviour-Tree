<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="MainTree">
  <BehaviorTree ID="3StageCycle">
    <AlwaysSuccess/>
  </BehaviorTree>

  <BehaviorTree ID="ExternalDoubleDeep">
    <AlwaysSuccess/>
  </BehaviorTree>

  <BehaviorTree ID="ExternalSingleDeep">
    <Fallback>
      <Lift_Pos lift_act_pos="rack_height"/>
      <Sequence>
        <moveLift lift_target_pos="rack_height"/>
        <Fallback>
          <turn_pos turn_act_pos="home"/>
          <Sequence>
            <moveTurntable turntable_target_pos="home"/>
            <SubTree ID="3StageCycle"
                     _autoremap="true"/>
            <Fallback>
              <Lift_Pos lift_act_pos="pick_height"/>
              <moveLift lift_target_pos="pick_height"/>
            </Fallback>
            <RackSensors/>
            <moveTelescope telescope_target_pos=""/>
          </Sequence>
        </Fallback>
      </Sequence>
    </Fallback>
  </BehaviorTree>

  <BehaviorTree ID="InternalRack">
    <Fallback>
      <Lift_Pos lift_act_pos="rack_height"/>
      <Sequence>
        <moveLift lift_target_pos="rack_height"/>
        <Fallback>
          <turn_pos turn_act_pos="home"/>
          <Sequence>
            <moveTurntable turntable_target_pos="home"/>
            <RackSensors/>
            <moveTelescope telescope_target_pos="telepick_internal_deep1_mm"/>
            <Fallback>
              <Inverter>
                <BinClearSensors/>
              </Inverter>
              <SubTree ID="JogForward"
                       _autoremap="true"/>
            </Fallback>
            <moveForks fork_pos="0"/>
            <SetBlackboard value="true"
                           output_key="pick_status"/>
            <SubTree ID="RetractTelescope"
                     _autoremap="true"/>
          </Sequence>
        </Fallback>
      </Sequence>
    </Fallback>
  </BehaviorTree>

  <BehaviorTree ID="JogForward">
    <AlwaysFailure/>
  </BehaviorTree>

  <BehaviorTree ID="MainTree">
    <Sequence name="OperationCycle">
      <Fallback>
        <ForkUp_copy fork_pos="0"/>
        <moveForks fork_pos="0"/>
      </Fallback>
      <IfThenElse name="CheckTelePos">
        <TelescopeHomeSensors/>
        <IfThenElse name="CheckTotePos">
          <BinPresenceSensors/>
          <SubTree ID="RetractTelescope"
                   _autoremap="true"/>
          <IfThenElse>
            <TelePos act_position="act_telescope_position"/>
            <Switch3 case_1="0"
                     case_2="1"
                     case_3="2"
                     variable="turntable_dir">
              <SubTree ID="InternalRack"
                       _autoremap="true"/>
              <SubTree ID="ExternalSingleDeep"
                       _autoremap="true"/>
              <SubTree ID="ExternalDoubleDeep"
                       _autoremap="true"/>
            </Switch3>
          </IfThenElse>
        </IfThenElse>
        <SubTree ID="JogForward"
                 _autoremap="true"/>
      </IfThenElse>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="RetractTelescope">
    <Switch2 case_1="1"
             case_2="2"
             variable="deep">
      <Fallback>
        <TelePos act_position="0"/>
        <moveTelescope telescope_target_pos="0"/>
      </Fallback>
      <Sequence>
        <Fallback>
          <TelePos act_position="845"/>
          <moveTelescope telescope_target_pos="845"/>
        </Fallback>
        <Fallback>
          <Lift_Pos lift_act_pos="pick_height"/>
          <moveLift lift_target_pos="pick_height"/>
        </Fallback>
        <Fallback>
          <TelePos act_position="0"/>
          <moveTelescope telescope_target_pos="0"/>
        </Fallback>
      </Sequence>
    </Switch2>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Condition ID="BinClearSensors"
               editable="true"/>
    <Condition ID="BinPresenceSensors"/>
    <Condition ID="ForkUp_copy"
               editable="true">
      <output_port name="fork_pos"/>
    </Condition>
    <Condition ID="Lift_Pos"
               editable="true">
      <input_port name="lift_act_pos"/>
    </Condition>
    <Condition ID="RackSensors"
               editable="true"/>
    <Condition ID="TelePos">
      <output_port name="act_position"/>
    </Condition>
    <Condition ID="TelescopeHomeSensors"/>
    <Action ID="moveForks"
            editable="true">
      <input_port name="fork_pos"
                  default="0">Fork Angle in Degrees</input_port>
    </Action>
    <Action ID="moveLift"
            editable="true">
      <input_port name="lift_target_pos"/>
    </Action>
    <Action ID="moveTelescope"
            editable="true">
      <input_port name="telescope_target_pos"/>
    </Action>
    <Action ID="moveTurntable"
            editable="true">
      <input_port name="turntable_target_pos"/>
    </Action>
    <Condition ID="turn_pos"
               editable="true">
      <input_port name="turn_act_pos"/>
    </Condition>
  </TreeNodesModel>

</root>
